\documentclass{amsart}
\input{setup/preamble.sty}
\input{setup/macros.sty}

\begin{document}
    \title{Tree-like Graphings of Countable Borel Equivalence Relations}
    \author{Zhaoshen Zhai}
    \date{\today}

    \begin{abstract}
        We present a streamlined exposition of a construction presented recently by R. Chen, A. Poulin, R. Tao, and A. Tserunyan, where it is proven that every locally-finite Borel graph with each component a quasi-tree induces a canonical treeable equivalence relation. {\color{red}{Write some more details...}}
    \end{abstract}

    \maketitle

    \setcounter{section}{-1}
    \section{Introduction}

    The purpose of this note is to provide a streamlined proof of a particular case of a construction presented in \cite{CPTT23}, in order to better understand the general formalism developed therein. We attempt to make this note self-contained, but nevertheless urge the reader to refer to the original paper for more detailed discussions and some generalizations of the results we have selected to include here.

    \subsection{Treeings of equivalence relations}

    A \textit{countable Borel equivalence relation (CBER)} on a standard Borel space $X$ is a Borel equivalence relation $E\subseteq X^2$ with each class countable. We are interested in special types of \textit{graphings} on a CBER $E\subseteq X^2$, i.e. a Borel graph $G\subseteq X^2$ whose connectedness relation is precisely $E$. For instance, a graphing of $E$ such that each component is a tree is called a \textit{treeing} of $E$, and the CBERs that admit treeings are said to be \textit{treeable}. The main results of \cite{CPTT23} provide new sufficient criteria for treeability of certain classes of CBERs, and in particular, they prove the following

    \begin{mainTheorem}[\cite{CPTT23}*{Theorem 1.1}]\label{thm:treeing_quasi-trees}
        If a CBER admits a locally-finite graphing whose components are quasi-trees, then it is treeable.
    \end{mainTheorem}

    Recall that metric spaces $X$ and $Y$ are \textit{quasi-isometric} if they are isometric up to a bounded multiplicative and additive error, and $X$ is a \textit{quasi-tree} if it is quasi-isometric to a simplicial tree; see \cite{Gro93} and \cite{DK18}.

    \subsection{Outline of the proof}

    Roughly speaking, the existence of a quasi-isometry $G|C\to T_C$ to a simplicial tree $T_C$ for each component $C\subseteq X$ induces a collection $\mc{H}(C)$ of `cuts' (subsets $H\subseteq C$ with finite boundary such that both $H$ and $C\comp H$ are connected), which are `tree-like' in the sense that
    \begin{enumerate}
        \item[1.] $\mc{H}(C)$ is \textit{finitely-separating}: each pair $x,y\in C$ is separated by finitely-many $H\in\mc{H}(C)$, and
        \item[2.] $\mc{H}(C)$ is \textit{dense towards ends}: each end in $G|C$ has a neighborhood basis in $\mc{H}(C)$.
    \end{enumerate}
    By Condition (1), these cuts have the structure of a profinite pocset with non-trivial points isolated, which in turn provide exactly the data to construct a `median graph' whose vertices are `ultrafilters'\footnote{As in \cite{CPTT23}, we call them \textit{orientations} instead, to avoid confusion with the more standard notion; see Definition \ref{def:orientation}.} thereof. Condition (2) then ensures that this graph has finite `hyperplanes', which allows us to apply a Borel `cycle-cutting' algorithm and obtain a canonical spanning tree. Each step above can be done in a uniform way to each component $C\subseteq G$, giving us the desired treeing of the CBER.
    \begin{equation*}
        \textrm{Quasi-tree}
            \ \ \xrightarrow{\ref{sec:graphs_with_dense_family_of_cuts}}\ \ 
        \begin{gathered}
            \textrm{Dense family} \\[-4pt]
            \textrm{of cuts}
        \end{gathered}
            \ \ \xrightarrow{\ref{sec:pocsets_of_cuts}+\ref{sec:finiteness_conditions_on_pocsets_dense_cuts}}\ \ 
        \begin{gathered}
            \textrm{Pocset w/} \\[-4pt]
            \textrm{non-triv. pts.} \\[-4pt]
            \textrm{isolated}
        \end{gathered}
            \ \ \xrightarrow{\ref{sec:the_dual_median_graph_of_a_pocset}+\ref{sec:finiteness_conditions_on_median_graph_dense_cuts}}\ \ 
        \begin{gathered}
            \textrm{Median graph} \\[-4pt]
            \textrm{w/ finite} \\[-4pt]
            \textrm{hyperplanes}
        \end{gathered}
            \ \ \xrightarrow{\ref{sec:spanning_trees_of_median_graphs_with_finite_hyperplanes}}\ \ 
        \begin{gathered}
            \textrm{Canonical} \\[-4pt]
            \textrm{spanning tree}
        \end{gathered}
    \end{equation*}

    {\color{red}{Write some more stuff to tie things together...}}

    \begin{remark*}
        We follow \cite{CPTT23}*{Convention 2.7}, where for a family $\mc{H}\subseteq2^X$ of subsets of a fixed set $X$, we write $\mc{H}^\ast\coloneqq\mc{H}\comp\l\{\em,X\r\}$ for the \textit{non-trivial} elements of $\mc{H}$.
    \end{remark*}

    \section{Graphs with Dense Families of Cuts}\label{sec:graphs_with_dense_family_of_cuts}

    \subsection{Ends of graphs}

    Let $(X,G)$ be a connected locally-finite graph, which, in the context of Theorem \ref{thm:treeing_quasi-trees}, will stand for a single component of the locally-finite graphing of a CBER.

    \begin{definition}
        For a subset $A\subseteq X$, we let $\del_\sf{iv}A\coloneqq A\cap\Ball_1(\lnot A)$ be its \textit{inner vertex boundary}, $\del_\sf{ov}A\coloneqq\del_\sf{iv}(\lnot A)$ be its \textit{outer vertex boundary}, and let $\del_\sf{ie}A\coloneqq G\cap(\del_\sf{ov}A\times\del_\sf{iv}A)$ and $\del_\sf{oe}A\coloneqq\del_\sf{ie}(\lnot A)$ respectively be its \textit{inner} and \textit{outer edge boundaries}. Let $\del_\sf{v}A\coloneqq\del_\sf{iv}A\cup\del_\sf{ov}A$ be the \textit{(total) vertex boundary} of $A$.
    \end{definition}

    Let $\mc{H}_{\del<\infty}(X)\subseteq2^X$ be the Boolean algebra of all $A\subseteq X$ with finite vertex boundary, called \textit{cuts} in $X$.

    \begin{definition}
        The \textit{end compactification} of $(X,G)$ is the Stone space $\widehat{X}$ of $\mc{H}_{\del<\infty}(X)$, whose non-principal ultrafilters are the \textit{ends} of $(X,G)$.
    \end{definition}

    We identify $X\into\widehat{X}$ via principal ultrafilter map $x\mapsto p_x$, so $\widehat{X}\comp X$ is the set of ends of $G$. By definition, $\widehat{X}$ admits a basis of clopen sets of the form $\widehat{A}\coloneqq\{p\in\widehat{X}\st A\in p\}$ for each $A\in\mc{H}_{\del<\infty}(X)$.

    \begin{definition}
        A family $\mc{H}\subseteq\mc{H}_{\del<\infty}(X)$ of cuts is \textit{dense towards ends} of $(X,G)$ if $\mc{H}$ contains a neighborhood basis for every end in $\widehat{X}\comp X$.

        In other words, $\mc{H}$ is dense towards ends if for every $p\in\widehat{X}\comp X$ and every (clopen) neighborhood $\widehat{A}\ni p$, where $A\in\mc{H}_{\del<\infty}(X)$, there is some $H\in\mc{H}$ with $p\in\widehat{H}\subseteq\widehat{A}$; it is useful to note that $\widehat{H}\subseteq\widehat{A}$ iff $H\subseteq A$.
    \end{definition}

    \subsection{Dense cuts induced by quasi-trees}\label{sec:dense_cuts_induced_by_quasi-trees}

    If $X$ is a quasi-tree $-$ and thus does not have arbitrary long cycles $-$ we expect that there is some finite bound $R<\infty$ such that the ends in $\widehat{X}\comp X$ are `limits' of cuts $\mc{H}_{\diam(\del)\leq R}(X)\subseteq\mc{H}_{\del<\infty}(X)$ with boundary diameter bounded by $R$. We show that this is indeed the case, in the sense that $\mc{H}_{\diam(\del)\leq R}(X)$ is dense towards ends of $(X,G)$.

    \begin{lemma}\label{lem:coarse_equivalence_controls_boundary_diameter}
        Let $f:(X,G)\to(Y,T)$ be a coarse-equivalence between connected graphs. For a fixed $H\in\mc{H}_{\del<\infty}(Y)$, $\diam(\del_\sf{v}f^{-1}(H))$ is uniformly bounded in terms of $\diam(\del_\sf{v}H)$.
    \end{lemma}
    \begin{proof}
        Since $f$ is bornologous, let $S<\infty$ be such that $xGx'$ implies $d(f(x),f(x'))\leq S$, so that for any $(x,x')\in\del_\sf{ie}f^{-1}(H)$, there is a path of length $\leq S$ between $f(x)\not\in H$ and $f(x')\in H$. Thus both $d(f(x),\del_\sf{v}H)$ and $d(f(x'),\del_\sf{v}H)$ are bounded by $S$, so $f(\del_\sf{v}f^{-1}(H))\subseteq\Ball_S(\del_\sf{v}H)$ and hence
        \begin{equation*}
            \diam(f(\del_\sf{v}f^{-1}(H)))\leq\diam(\del_\sf{v}H)+2S.
        \end{equation*}
        That $f$ is a coarse-\textit{equivalence} gives us a uniform bound of $\diam(\del_\sf{v}f^{-1}(H))$ in terms of $\diam(\del_\sf{v}H)$.
    \end{proof}

    In particular, if $\diam(\del_\sf{v}H)$ is itself also uniformly bounded, then so is $\diam(\del_\sf{v}f^{-1}(H))$.

    \begin{proposition}\label{prp:invariant_of_density_coarse_equivalence}
        The class of connected locally-finite graphs in which $\mc{H}_{\diam(\del)\leq R}$ is dense towards ends for some $R<\infty$ is invariant under coarse equivalence.
    \end{proposition}
    \begin{proof}
        Let $(X,G)$, $(Y,T)$ be connected locally-finite graphs, $f:X\to Y$ be a coarse equivalence with quasi-inverse $g:Y\to X$, and suppose $\mc{H}_{\diam(\del)\leq S}(Y)$ is dense towards ends for some $S<\infty$. By Lemma \ref{lem:coarse_equivalence_controls_boundary_diameter}, pick some $R<\infty$ so that for any $H\in\mc{H}_{\diam(\del)\leq S}(Y)$, we have $f^{-1}(H)\in\mc{H}_{\diam(\del)\leq R}(X)$.

        Fix an end $U\in\widehat{X}\comp X$ with $U\in\widehat{A}$ for some $A\in\mc{H}_{\del<\infty}(X)$. We need to find some $B\in\mc{H}_{\del<\infty}(Y)$ such that $\widehat{f}(U)\in\widehat{B}$ and $f^{-1}(B)\subseteq A$, for then $\widehat{f}(U)\in\widehat{H}$ for some $B\supseteq H\in\mc{H}_{\diam(\del)\leq S}(Y)$, and hence we have
        \begin{equation*}
            U\in\widehat{f^{-1}(H)}\subseteq\widehat{f^{-1}(B)}\subseteq\widehat{A}
        \end{equation*}
        with $f^{-1}(H)\in\mc{H}_{\diam(\del)\leq R}(X)$. For convenience, let $D<\infty$ be the uniform distance $d(1_X,g\circ f)$.

        To this end, note that $\widehat{f}(U)\in\widehat{B}$ iff $U\in\widehat{f^{-1}(B)}$. Since $U\in\widehat{A}$, the latter can occur if $|A\symdiff f^{-1}(B)|<\infty$, and so we need to find such a $B\in\mc{H}_{\del<\infty}(Y)$ with the additional property that $f^{-1}(B)\subseteq A$.
        \begin{leftbar}
            \textit{Attempt 1.} Set $B\coloneqq g^{-1}(A)\in\mc{H}_{\del<\infty}(Y)$. Then $f^{-1}(B)\subseteq\Ball_D(A)$ since if $(g\circ f)(x)\in A$, then
                \begin{equation*}
                    d(x,A)\leq d(x,(g\circ f)(x))\leq d(1_X,g\circ f)=D.
                \end{equation*}
            By local-finiteness of $G$, we see that $A\symdiff f^{-1}(B)=A\comp f^{-1}(B)$ is finite, as desired.
        \end{leftbar}
        However, it is \textit{not} the case that $f^{-1}(B)\subseteq A$. To remedy this, we `shrink' $A$ by $D$ to $A'$ so that $\Ball_D(A')\subseteq A$, and take $B\coloneqq g^{-1}(A')$ instead. Indeed, $A'\coloneqq\lnot\Ball_D(\lnot A)\subseteq A$ works, since $f^{-1}(B)\subseteq\Ball_D(A')$ as before, so $A'\symdiff f^{-1}(B)=A'\comp f^{-1}(B)$ is finite. Also, $A\symdiff A'$ is finite since $x\in A\symdiff A'$ iff $x\in A$ and $d(x,\lnot A)\leq D$, so $A\symdiff f^{-1}(B)$ is finite too. It remains to show that $\Ball_D(A')\subseteq A$, for then $f^{-1}(B)\subseteq A$ as desired.

        Indeed, if $y\in\Ball_D(A')$, then by the (reverse) triangle-inequality we have $d(y,\lnot A)\geq d(x,\lnot A)-d(x,y)$ for all $x\in A'$. But $d(x,\lnot A)>D$, strictly, so $d(y,\lnot A)>D-D=0$, and hence $y\in A$.
    \end{proof}

    \begin{corollary}
        If $(X,G)$ is a locally-finite quasi-tree, then $\mc{H}_{\diam(\del)\leq R}(X)$ is dense towards ends for some $R<\infty$.
    \end{corollary}
    \begin{proof}
        Observe that $\mc{H}_{\diam(\del)\leq2}(T)$ is dense towards ends for any tree $T$, and invoke Proposition \ref{prp:invariant_of_density_coarse_equivalence}.
    \end{proof}

    \section{Pocsets of Dense Families of Cuts}

    \subsection{Pocsets of cuts}\label{sec:pocsets_of_cuts}

    The family $\mc{H}_{\diam\del\leq R}(X)$ of cuts have the structure of a `profinite pocset', which we first study abstractly. We then deduce some properties of the pocset induced by a \textit{dense} family of cuts.

    \begin{definition}\label{def:profinite_pocset}
        A \textit{pocset} $(\mc{H},\leq,\lnot,0)$ is a poset $(\mc{H},\leq)$ equipped with an order-reversing involution $\lnot:\mc{H}\to\mc{H}$ and a least element $0\neq\lnot0$ such that $0$ is the only lower-bound of $H,\lnot H$ for every $H\in\mc{H}$. We call the elements in $\mc{H}$ \textit{half-spaces}.

        A \textit{profinite pocset} is a pocset $\mc{H}$ equipped with a compact topology making $\lnot$ continuous and is \textit{totally order-disconnected}, in the sense that if $H\not\leq K$, then there is a clopen upward-closed $U\subseteq\mc{H}$ with $H\in U\not\ni K$.
    \end{definition}

    \begin{remark}
        Such a topology is automatically Hausdorff and zero-dimensional.
    \end{remark}

    We are primarily interested in subpocsets of $(2^X,\subseteq,\lnot,\em)$, which is profinite if equipped with the product topology of the discrete space $2$. Indeed, $2^X$ admits a base of \textit{cylinder sets} $-$ which are finite intersections of sets of the form $\pi^{-1}_x(i)$ where $x\in X$, $i\in\l\{0,1\r\}$, and $\pi_x:2^X\to2$ is the projection $-$ making $\lnot$ continuous since cylinders are clopen. {\color{red}{Show that it is totally order-disconnected.}}

    The following proposition gives a sufficient criteria for subpocsets of $2^X$ to be profinite. We also show in this case that every non-trivial element $H\in\mc{H}^\ast$ is isolated, which will important in Section \ref{sec:the_dual_median_graph_of_a_pocset}.

    \begin{proposition}\label{prp:finitely-separating_non-trivial_isolated}
        Let $X$ be a set and $\mc{H}\subseteq2^X$ be a subpocset. If $\mc{H}$ is finitely-separating, then $\mc{H}\subseteq2^X$ is closed and every non-trivial element is isolated.
    \end{proposition}
    \begin{proof}
        It suffices to show that the limit points of $\mc{H}$ are trivial, so let $A\in2^X\comp\l\{\em,X\r\}$. Fix $x\in A\not\ni y$. Since $\mc{H}$ is finitely-separating, there are finitely-many $H\in\mc{H}$ with $x\in H\not\ni y$, and for each such $H\in\mc{H}\comp\l\{A\r\}$, we have either some $x_H\in A\comp H$ or $y_H\in H\comp A$. Let $U\subseteq2^X$ be the family of all subsets $B\subseteq X$ containing $x$ and each $x_H$ but not $y$ or any $y_H$.

        This is the desired neighborhood isolating $A\in U$. Indeed, it is (cl)open since it is the \textit{finite} intersection of cylinders prescribed by the $x_H$'s and $y_H$'s, and it is disjoint from $\mc{H}\comp\l\{A\r\}$ by construction.
    \end{proof}

    \begin{example}\label{exa:finitely_separating_iff_on_boundary_of_finite}
        For a connected graph\footnote{If $(X,G)$ is locally-finite, then this condition is necessary, since then each $x\in X$ is separated from each of its finitely-many neighbors by finitely-many $H\in\mc{H}$.} $(X,G)$, a subpocset $\mc{H}\subseteq2^X$ is finitely-separating if each $x\in X$ is on the boundary of finitely-many half-spaces. Indeed, any $H\in\mc{H}$ separating $x,y\in X$ separates some edge on any fixed path between $x$ and $y$, and there are only finitely-many such $H$ for each edge.

        In particular, the subpocset $\mc{H}_{\diam(\del)\leq R}(X)$ for any fixed $R<\infty$ (see Section \ref{sec:dense_cuts_induced_by_quasi-trees}) is finitely-separating.
    \end{example}


    \subsection{Finiteness conditions on $\mc{H}$ induced by dense cuts}\label{sec:finiteness_conditions_on_pocsets_dense_cuts}

    Let $(X,G)$ be a connected locally-finite graph and consider a family $\mc{H}\subseteq\mc{H}_{\del<\infty}$ of cuts that are dense towards ends of $G$. {\color{red}{TODO}}

    \section{The Dual Median Graph with Finite Hyperplanes}

    \subsection{The dual median graph of a pocset}\label{sec:the_dual_median_graph_of_a_pocset}

    Let $\mc{H}$ be a profinite subpocset with every non-trivial element isolated; for instance, if $\mc{H}$ is finitely-separating, and in particular the cuts $\mc{H}_{\diam(\del)\leq R}(X)$ for some locally-finite connected graph $(X,G)$. We present a classical construction in geometric group theory (see \cite{Dun79}, \cite{Rol98}, \cite{Sag95}, and \cite{NR03} for applications) of a `tree-like' graph associated to such a pocset.
    
    \begin{definition}\label{def:orientation}
        An \textit{orientation} on $\mc{H}$ is an upward-closed subset $U\subseteq\mc{H}$ containing exactly one of $H,\lnot H$ for each $H\in\mc{H}$. We let $\mc{U}(\mc{H})$ denote the set of all orientations on $\mc{H}$ and let $\mc{U}^\circ(\mc{H})$ denote the clopen ones.
    \end{definition}

    Intuitively, an orientation is a `maximally consistent' choice of half-spaces\footnote{This can be formalized by letting $\sim$ be the equivalence relation on $\mc{H}$ given by $H\sim\lnot H$. Letting $\del:\mc{H}\to\mc{H}/\!\!\sim$ denote the quotient map, orientations $U\subseteq\mc{H}$ then correspond precisely to sections $\phi:\mc{H}/\!\!\sim\,\to\mc{H}$ of $\del$ such that $\phi(\del H)\not\subseteq\lnot\phi(\del K)$ for every $H,K\in\mc{H}$; the latter condition rules out `orientations' of the form $\leftarrow\hspace{-4.15pt}|\,\,|\hspace{-4.15pt}\rightarrow$.}.

    \begin{example}
        Each $x\in X$ induces its \textit{principal orientation} $\widehat{x}\coloneqq\l\{H\in\mc{H}\st x\in H\r\}=\mc{H}\cap\pi^{-1}_x(1)$ $-$ which is clearly clopen in $\mc{H}$ $-$ and gives us a canonical map $X\to\mc{U}^\circ(\mc{H})$. However, this map is \textit{not necessarily} injective, and we call a fiber $[x]_\mc{H}\coloneqq\l\{y\in X\st\widehat{x}=\widehat{y}\r\}$ thereof an \textit{$\mc{H}$-block}.
    \end{example}

    The goal of this section is to canonically construct a graph whose vertices are clopen orientations on $\mc{H}$.

    \begin{definition}
        A \textit{median graph} is a connected graph $(X,G)$ such that for any $x,y,z\in X$, the intersection
        \begin{equation*}
            [x,y]\cap[y,z]\cap[x,z]
        \end{equation*}
        is a singleton, whose element $\l\langle x,y,z\r\rangle$ is called the \textit{median} of $x,y,z$. Thus we have a ternary median operation $\l\langle\cdot,\cdot,\cdot\r\rangle:X^3\to X$, and a \textit{median homomorphism} $f:(X,G)\to(Y,H)$ is a map preserving said operation.
    \end{definition}

    Some basic properties of median graphs are given in Section \ref{sec:convex_half-spaces_of_media_graphs}. For more comprehensive references and their general theory, see \cite{Rol98} and \cite{Bow22}.

    \begin{proposition}\label{prp:construction_of_dual_median_graph}
        Let $\mc{H}$ be a profinite pocset with every non-trivial element isolated. Then the graph $\mc{M}(\mc{H})$, whose vertices are clopen orientations $\mc{U}^\circ(\mc{H})$ and whose edges are pairs $\l\{U,V\r\}$ with $V=U\symdiff\l\{H,\lnot H\r\}$ for some $\subseteq$-minimal $H\in\mc{H}^\ast$, is a median graph with path metric $d(U,V)=|U\symdiff V|/2$ and medians
        \begin{equation*}
            \begin{aligned}
                \l\langle U,V,W\r\rangle&\coloneqq\l\{H\in\mc{H}\st H\textrm{ belongs to at least two of }U,V,W\r\} \\
                                        &=(U\cap V)\cup(V\cap W)\cup(U\cap W).
            \end{aligned}
        \end{equation*}
    \end{proposition}

    \begin{proof}
        First, $V\coloneqq U\symdiff\l\{H,\lnot H\r\}$ as above is clopen since $H,\lnot H\in\mc{H}^\ast$ are isolated (whence $\l\{H\r\},\l\{\lnot H\r\}$ are clopen), and it is an orientation by $\subseteq$-minimality of $H$. That $\mc{M}(\mc{H})$ is connected follows from the following claim by noting that $U\symdiff V\not\ni X$ is clopen, so it is a compact set of isolated points, whence finite.
        \begin{center}
            \begin{minipage}{0.95\textwidth}
                \begin{claim*}
                    There is a path between $U,V$ iff $U\symdiff V$ is finite, in which case $d(U,V)=|U\symdiff V|/2$.
                \end{claim*}
                \begin{proof}
                    If $(U_i)_{i<n}$ is a path from $U\eqqcolon U_0$ to $V\eqqcolon U_{n-1}$, then, letting $\l\{H_i,\lnot H_i\r\}\coloneqq U_i\symdiff U_{i-1}$ for all $1\leq i<n$ gives us a sequence $(H_i)_{i<n}$ inducing\footnote{In the sense that $U_i=U_{i-1}\symdiff\l\{H_i,\lnot H_i\r\}$ and $H_i\in U_i$ for each $1\leq i<n$; see \cite{Tse20}*{Definition 2.20}.} this path, whence $U\symdiff V$ consists of $\l\{H_i\r\}_{i<n}$ and their complements. Thus $U\symdiff V=2n=2d(U,V)$, as desired.

                    \hspace{0.2in}Conversely, if $U\symdiff V=\l\{H_1,\dots,H_n\r\}\sqcup\l\{K_1,\dots,K_m\r\}$ with $U\comp V=\l\{H_i\r\}$ and $V\comp U=\l\{K_j\r\}$, then $\lnot H_i\in V\comp U$ and $\lnot K_j\in U\comp V$ for all $i<n$ and $j<m$, so $n=m$ and $V=U\cup\l\{\lnot H_i\r\}\comp\l\{H_i\r\}$. We claim that there is a permutation $\sigma\in S_n$ such that $(H_{\sigma(i)})$ induces a path from $U\eqqcolon U_0$, which is the desired path from $U$ to $V$. Choose a minimal $H\in\l\{H_i\r\}$, which is also minimal in $U$: if $K\subseteq H$ for some $K\in U$, then $\lnot H\subseteq\lnot K$, and hence $\lnot K\in V$, so $K=H_i\subseteq H$ for some $i$, forcing $K=H$. Set $U_1\coloneqq U\symdiff\l\{H,\lnot H\r\}$, which is a clopen orientation. Continuing in this manner by choosing a minimal element in $\l\{H_i\r\}\comp\l\{H\r\}$ $-$ and so on $-$ gives us the desired path with $d(U,V)=n$.\phantom\qedhere\hfill$\square$
                \end{proof}
            \end{minipage}
        \end{center}
        Finally, we show that $\mc{M}(\mc{H})$ is a median graph. Fix $U,V,W\in\mc{U}^\circ(\mc{H})$, and note that for any $M\in\mc{U}^\circ(\mc{H})$, we have by the triangle inequality that $M\in[U,V]$ iff $(U\comp M)\cup(M\comp V)\subseteq U\comp V$, which clearly occurs iff $U\cap V\subseteq M\subseteq U\cup V$. Thus, a vertex $M$ lies in the triple intersection $[U,V]\cap[V,W]\cap[U,W]$ iff
        \begin{equation*}
            (U\cap V)\cup(V\cap W)\cup(U\cap W)\subseteq M\subseteq(U\cup V)\cap(V\cup W)\cap(U\cup W).
        \end{equation*}
        Note that the two sides coincide, so $M=\l\langle U,V,W\r\rangle$ $-$ which is clopen if $U,V,W$ are $-$ is as claimed.
    \end{proof}

    Given such a pocset $\mc{H}$, the graph $\mc{M}(\mc{H})$ constructed above is called the \textit{dual}\footnote{The name is justified by a Stone-type duality between median graphs with median homomorphisms and profinite pocsets whose non-trivial points are isolated with continuous maps, where from a median graph one can construct a canonical pocset of `convex' half-spaces (see \cite{CPTT23}*{Section 2.D} for details).} median graph of $\mc{H}$. It is worth noting that if $\mc{H}$ is \textit{nested}, then $\mc{M}(\mc{H})$ is in fact a tree (see Appendix \ref{app:tree_of_orientations_on_nested}):

    \begin{definition}\label{def:nested}
        Let $\mc{H}\subseteq2^X$ be a pocset. Two half-spaces $H,K\in\mc{H}$ are \textit{nested} if $\lnot^iH\cap\lnot^jK=\em$ for some $i,j\in\l\{0,1\r\}$, where $\lnot^0H\coloneqq H$ and $\lnot^1H\coloneqq\lnot H$. We say that $\mc{H}$ is \textit{nested} if every pair $H,K\in\mc{H}$ is nested.
    \end{definition}

    Nonetheless, in the general non-nested case, there is a sufficient criteria for the existence of a \textit{canonical} spanning tree of $\mc{M}(\mc{H})$, which we now explore.

    \subsection{Finiteness conditions on $\mc{M}(\mc{H})$ induced by {\color{red}{???}}}\label{sec:finiteness_conditions_on_median_graph_dense_cuts}

    \section{Median Graphs and their Canonical Spanning Trees}\label{sec:spanning_trees_of_median_graphs_with_finite_hyperplanes}

    \subsection{Convex half-spaces of median graphs}\label{sec:convex_half-spaces_of_media_graphs}
    \renewcommand{\-}{\textrm{---}}

    Let $(X,G)$ be a median graph. The presence of the median operation gives rise to a canonical finitely-separating pocset of \textit{convex} (and co-convex) half-spaces $\mc{H}_\textrm{cvx}(X)\subseteq2^X$ with a very rigid structure, which we now explore.

    To do so, we need to first understand the geometry of \textit{projections} in median graphs, which we summarize in the following

    \begin{proposition}\label{prp:projections}
        For any $A\in2^X\comp\l\{\em,X\r\}$ and $x\in X$, there is a unique point in $\cvx(A)$ between $x$ and every point in $A$, called the $\mathrm{projection}$ of $x$ towards $A$, denoted $\proj_A(x)$. Furthermore:
        \begin{enumerate}
            \item We have $\proj_A=\proj_{\cvx(A)}$; i.e. $\proj_A(x)$ is also between $x$ an every point in $\cvx(A)$.
            \item We have $\bigcap_{a\in A}[x,a]=[x,\proj_A(x)]$, and for any $y$ in this set, we have $\proj_A(y)=\proj_A(x)$.
            \item The map $\proj_A:X\onto\cvx(A)$ is the unique median homomorphism fixing $\cvx(A)$.
        \end{enumerate}
    \end{proposition}

    Since we only regard this as a technical tool, we shall prove it in Appendix \ref{app:projections}.

    For each $x,y\in X$, the \textit{cone} at $y$ away from $x$ is $\cone_x(y)\coloneqq\l\{z\in X\st y\in[x,z]\r\}$, consisting of all $z\in X$ closer to $y$ than to $x$. The inward edge boundaries $\del_\sf{ie}H$ for $H\in\mc{H}_\textrm{cvx}^\ast(X)$ are called \textit{hyperplanes}.

    \begin{lemma}\label{lem:cones_are_convex}
        For any $x,y\in X$, $\cone_x(y)$ is convex, and if $xGy$, then $\cone_x(y)\sqcup\cone_y(x)=X$.
    \end{lemma}
    \begin{proof}
        
    \end{proof}

    \begin{lemma}\label{lem:half-spaces_are_cones}
        Each edge $(x,y)\in G$ is on a unique hyperplane, namely the inward boundary of $\cone_x(y)$, and conversely, each half-space $H\in\mc{H}^\ast_\mathrm{cvx}(X)$ is $\cone_x(y)$ for every $(x,y)\in\del_\sf{ie}H$.

        Thus, hyperplanes are equivalence classes of edges. Furthermore, this equivalence relation is generated by parallel sides of squares (i.e., $4$-cycles).
    \end{lemma}
    \begin{proof}
        We have $\cone_x(y)\in\mc{H}_\textrm{cvx}^\ast(X)$ by the above lemma, and clearly $(x,y)\in\del_\sf{ie}\cone_x(y)$.

        Conversely, for any $H\in\mc{H}_\textrm{cvx}^\ast(X)$ and $(x,y)\in\del_\sf{ie}H$, we have $H=\cone_x(y)$: if $z\in\cone_x(y)\cap\lnot H$, then $[x,z]\subseteq\lnot H$ by convexity of $\lnot H$, and hence $y\not\in H$, a contradiction; if $z\in H\cap\lnot\cone_x(y)$, then $z\in\cone_y(x)$, and hence $x\in[y,z]\subseteq H$ by convexity of $H$, a contradiction.

        Finally, parallel edges of a strip of squares generate the same hyperplane since, for a given square, each vertex is between its neighbors and hence any hyperplane containing an edge contains its opposite edge. On the other hand, let $(a,b),(c,d)\in\del_\sf{ie}H$ for some $H\in\mc{H}_\textrm{cvx}^\ast(X)$. For any geodesic between $a,c\in\del_\sf{ov}H$, which lies in the {\color{red}{convex}} set $\del_\sf{ov}H$, {\color{red}{???}}
    \end{proof}

    \begin{lemma}\label{lem:non-nested_iff_embedding_of_hamming}
        Two half-spaces $H,K\in\mc{H}_\mathrm{cvx}^\ast(X)$ are non-nested iff there is an embedding $\l\{0,1\r\}^2\into X$ of the Hamming cube into the four corners $\lnot^iH\cap\lnot^jK$.

        In particular, if $H,K\in\mc{H}_\mathrm{cvx}^\ast(X)$ are non-nested, then $\del_\sf{v}H\cap\del_\sf{v}K\neq\em$.
    \end{lemma}
    \begin{proof}
        Let $H,K$ be non-nested and take $x_1\in H\cap K$ and $x_2\in H\cap\lnot K$. Since $H$ is connected, any geodesic between $x_1,x_2$ crosses an edge $(x_1',x_2')\in\del_\sf{oe}K$ in $H$. Similarly, there is an edge $(y_1',y_2')\in\del_\sf{oe}K$ in $\lnot H$, so we may slide both edges along $\del_\sf{oe}K$ to obtain the desired square (see Lemma \ref{lem:half-spaces_are_cones}).

        Conversely, the half-spaces cutting the square are clearly non-nested.
    \end{proof}

    \begin{proposition}\label{prp:H_blocks_form_a_median_graph}
        Let $\mc{H}\subseteq\mc{H}_\mathrm{cvx}(X)$ be a subpocset of convex half-spaces. Then:
        \begin{enumerate}
            \item $\mc{H}$ is finitely-separating, and hence $\mc{M}(\mc{H})$ is a median graph by Propositions \ref{prp:finitely-separating_non-trivial_isolated} and \ref{prp:construction_of_dual_median_graph}.
            \item The principal orientations map $X\to\mc{U}^\circ(\mc{H}):x\mapsto\widehat{x}$ is surjective, and hence induces a median graph structure on the set of $\mc{H}$-blocks $X/\mc{H}$.
        \end{enumerate}
    \end{proposition}
    Explicitly, $([x]_\mc{H},[y]_\mc{H})$ is an edge in $X/\mc{H}$ iff $(\widehat{x},\widehat{y})\in\mc{M}(\mc{H})$, which occurs iff
    \begin{proof}
        That $\mc{H}$ is finitely-separating follows from Example \ref{exa:finitely_separating_iff_on_boundary_of_finite} and Lemma \ref{lem:half-spaces_are_cones}.
    \end{proof}

    \subsection{Canonical spanning trees}

    \begin{proposition}\label{prp:canonical_spanning_trees}
        Every countable median graph with finite hyperplanes admits a canonical spanning tree.
    \end{proposition}
    \begin{proof}
        Let $(X,G)$ be a countable median graph with finite hyperplanes. By Lemma \ref{lem:non-nested_iff_embedding_of_hamming}, if two half-spaces $H,K\in\mc{H}^\ast_\textrm{cvx}(X)$ are non-nested, then $\del_\sf{v}H\cap\del_\sf{v}K\neq\em$, so looking at the intersection graph of the boundaries furnishes a countable colouring $\mc{H}^\ast_\textrm{cvx}(X)=\bigsqcup_{n\in\N}\mc{H}^\ast_n$ such that each $H,\lnot H$ receive the same color and that each $\mc{H}_n\coloneqq\mc{H}_n^\ast\cup\l\{\em,X\r\}$ is a \textit{nested} subpocset. For each $n\in\N$, let $\mc{K}_n\coloneqq\bigcup_{m\geq n}\mc{H}_m$.

        We shall inductively construct an increasing chain of subforests $T_n\subseteq G$ such that the components of $T_n$ are exactly the $\mc{K}_n$-blocks. Then, the increasing union $T\coloneqq\bigcup_nT_n$ is a spanning tree, since each $(x,y)\in G$ lies in a $\mc{K}_n$-block for sufficiently large $n$ (namely, the $n$ such that $\cone_x(y)\in\mc{H}^\ast_{n-1}$, since $\cone_x(y)$ and its complement are the only half-spaces separating $x$ and $y$ by Lemma \ref{lem:half-spaces_are_cones}).

        Since each pair of distinct points is separated by a half-space, the $\mc{K}_0=\mc{H}_\textrm{cvx}(X)$-blocks are singletons, so put $T_0\coloneqq\em$. Suppose that a forest $T_n$ is constructed as required. Note that each $\mc{K}_{n+1}$-block $Y\in X/\mc{K}_{n+1}$ is not separated by any half-spaces in $\mc{H}_m$ for $m>n$, but is separated (by Lemma \ref{lem:half-spaces_are_cones}) by $\mc{H}_n$ into the $\mc{K}_n$-blocks contained in $Y$, and those correspond precisely to the $\mc{H}_n$-blocks in $Y/\mc{H}_n$. For each $G$-adjacent pair $A,B\in Y/\mc{H}_n$, which is separated by a unique half-space in $H\in\mc{H}_n$, we may pick an edge from the \textit{finite} hyperplane $\del_\sf{ie}H$. Since each $Y/\mc{H}_n$ is a tree by Corollary \ref{cor:nested_implies_tree}, and a single edge is picked between every pair of $G$-adjacent blocks therein, the graph $T_{n+1}$ obtained from $T_n$ by adding all such edges is a forest whose components are exactly the $\mc{K}_{n+1}$-blocks.
    \end{proof}

    \begin{corollary}
        If a CBER admits a graphing whose components are median graphs, then it has a subtreeing.
    \end{corollary}

    \begin{appendices}
        \section{Tree of orientations on a nested pocset of sets}\label{app:tree_of_orientations_on_nested}

        Let $X$ be a set and let $\mc{H}\subseteq2^X$ be a profinite pocset with non-trivial elements isolated (see Definition \ref{def:profinite_pocset}); say, if $\mc{H}$ is finitely-separating. By Proposition \ref{prp:construction_of_dual_median_graph}, the clopen orientations $\mc{U}^\circ(\mc{H})$ form the vertices of a median graph $\mc{M}(\mc{H})$, whose edges are given by `minimal half-space flippings'.

        We show in this appendix that if $\mc{H}$ is also \textit{nested} (see Definition \ref{def:nested}), then $\mc{M}(\mc{H})$ is in fact a tree, and so we may bypass the Borel cycle-cutting algorithm in Section \ref{sec:spanning_trees_of_median_graphs_with_finite_hyperplanes} (hence Section \ref{sec:finiteness_conditions_on_median_graph_dense_cuts} too) and obtain a treeing directly. This result is motivated by a similar construction in \cite{Tse20}, and is proved with similar methods.

        \begin{lemma}\label{lem:no-backtrack}
            A path in $\mc{M}(\mc{H})$ from $U_0$ induced by $(H_i)_{i<n}$, $n\geq3$, has no backtracking iff $H_i\neq\lnot H_{i-1}$ for every $1\leq i<n$.
        \end{lemma}
        \begin{proof}
            Take $2\leq i\leq n$. It suffices to show that $U_{i-2}=U_i$ iff $H_{i-1}=\lnot H_{i-2}$.
            \begin{itemize}
                \item[($\Rightarrow$).] We have by definition that $U_i=U_{i-2}\cup\{\lnot H_{i-1},\lnot H_{i-2}\}\comp\l\{H_{i-1},H_{i-2}\r\}$, so since $H_{i-2}\in U_{i-2}=U_i$, we have $H_{i-2}=\lnot H_{i-1}$ as desired.
                \item[($\Leftarrow$).] Again by definition, by noting that the half-space flippings cancel out.\qed
            \end{itemize}
        \end{proof}

        \begin{proposition}\label{prp:strictly-inc}
            If $(H_i)_{i<n}$ induces a path in $\mc{M}(\mc{H})$ with no backtracking, then $(H_i)$ is strictly increasing.
        \end{proposition}
        \begin{proof}
            By Lemma \ref{lem:no-backtrack}, we have $H_i\neq\lnot H_{i-1}$ for every $1\leq i<n$. Thus, since $H_i\in U_i=U_{i-1}\cup\{\lnot H_{i-1}\}\comp\l\{H_{i-1}\r\}$, we see that $H_i\in U_{i-1}$. Clearly $H_i\neq H_{i-1}$. It suffices to remove the three cases when $H_i\subseteq H_{i-1}$, $H_{i-1}\subseteq\lnot H_i$, and $\lnot H_i\subseteq H_{i-1}$, since then nestedness of $\mc{H}$ gives us $H_{i-1}\subsetneq H_i$, as desired.
            \begin{itemize}
                \item If $H_i\subseteq H_{i-1}$, then $H_{i-1}\in U_i$, contradicting the definition of $U_i$.
                \item If $H_{i-1}\subseteq\lnot H_i$, then $\lnot H_i\in U_{i-1}$ by upward-closure of $U_{i-1}$, a contradiction.
                \item If $\lnot H_i\subseteq H_{i-1}$, then $H_{i-1}\in U_{i+1}$ by upward-closure of $U_{i+1}\ni\lnot H_i$. But since $H_{i-1}\neq\lnot H_i$, we have by definition of $U_{i+1}$ that $H_{i-1}\in U_i$, a contradiction.\qed
            \end{itemize}
        \end{proof}

        \begin{corollary}\label{cor:nested_implies_tree}
            If $\mc{H}$ is a nested profinite pocset with non-trivial elements isolated, then $\mc{M}(\mc{H})$ is a tree.
        \end{corollary}
    \end{appendices}

    \begin{bibdiv}
        \begin{biblist}*{labels={alphabetic}}
            \bibselect{setup/bibliography}
        \end{biblist}
    \end{bibdiv}
\end{document}
